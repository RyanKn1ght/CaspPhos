---
title: "Caspase Substrate Analysis"
author: "Ryan Knight"
date: "24/01/2021"
output: 
  bookdown::html_document2:
    fig_caption: yes
    css: "resources/style.css"
bibliography: resources/references.bib
---

<!-- The analysis does knit, but takes a while. Below: R environment setup -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      results = FALSE,
                      fig.retina = 3)
```

```{r requirements}
library(tidyverse) #Data manipulation.
library(reticulate) #Doesn't need to be called to run, but does to knit.
library(ggseqlogo) #Draws sequence logos.
library(gridExtra) # Presents plots in grid format.

#Selects data to be passed to the phosphate site machine learning model.
source("libraries/preparesites.R") 

#Even if python is configured to anaconda in settings, this line must be run in order to knit.
#You probably don't have an environment called this, see readme troubleshooting for conda guidance.
use_condaenv("re-reticulate")
```

# Introduction

**Caspases** (**c**ysteine **asp**art**ases**), are a family of proteases that carry out essential roles in forms of programmed cell death. 

Cellular stress and infection promote the assembly of inflammasome complexes, leading to the activation of inflammatory caspases. Activation of these inflammatory caspases, Caspase-1, Caspase-4 and Caspase-5 in humans, and Caspase-1 and Caspase-11 in mice, induces a morphologically distinct form of programmed cell death known as pyroptosis. When undergoing pyroptosis, cells rupture and release their contents, including pro-inflammatory cytokines and danger signals to both prevent intracellular pathogen replication and induce an immune response.

Despite their namesake, there exists substantive evidence that caspases do not exclusively cleave substrates at aspartate residues but have a propensity to act at a variety of other amino acid residues [@seaman_2016], most notably glutamate, possessing similar acidic properties to aspartate.

For our previous work (unpublished data), we compiled a database of inflammatory caspase substrates. As appreciation is developing for the more nuanced nature of caspase cleavage site consensus sequences, this report aims to provide a reproducible analysis and visualisation of features of caspase cleavage sites.

# Methods and Results

<!-- Initial tidying of data -->

```{r tidy-phosphate}

#Load raw format substrate table. Rename position notation with numbers to identify locations within the shorter sequence better.
file <- "./data/raw/caspase_substrates.csv"
substrates <- read.csv(file) %>% janitor::clean_names()
names(substrates)[c(12:20, 22, 24:33)] <- seq(1, 20)

#Remove columns unnecessary for this application, Tidy up the table names
# Strips whitespace that is in the sequence by accident in the standard data set.
# Capitalise sequence in the event that there are some lowercase letters included by mistake.
# Short sequences with empty spaces (-) cut out as removing - will mis-align them.
# Default dataset contains extra NAs rows in cleaved_by, so they should be removed.
sequence_table <- substrates %>% 
  select(uniprot_id, species, cleaved_by, `1`:`9`, `10`, `11`:`20`, concatenated_p10_p10_sequence) %>%
  rename(sequence = concatenated_p10_p10_sequence) %>% 
  mutate(sequence = str_replace(sequence, " ", "")) %>%
  mutate(sequence = toupper(sequence)) %>%
  filter(!(grepl("-", sequence))) %>%
  na.omit()

#Reduce table down to a list of potential phosphorylation sites (S,T,Y).
# Rearrange into deepphos format.
# This is a second dataset as sequence_table can be used for other things.
potential_sites <- sequence_table %>%
  pivot_longer(names_to = "site", 
               values_to = "residue", 
               cols = c(`1`:`9`, `10`, `11`:`20`)) %>%
  relocate(site, .after = uniprot_id) %>%
  filter(residue %in% c("S", "T", "Y")) 
  

#The prediction algorithm handles sites in two groups, (S and T) and Y.
potential_sites_ST <- potential_sites %>% prepare_sites(c("S","T"))
potential_sites_Y <- potential_sites %>% prepare_sites("Y")

#Write to csv to retain the data.
write.table(potential_sites_ST, "./data/processed/all_potential_ST.csv", quote = F, sep = ",", col.names = F, row.names = F)
write.table(potential_sites_Y, "./data/processed/all_potential_Y.csv", quote = F, sep = ",", col.names = F, row.names = F)

```

## Visualisation of consensus sequence features

<!-- Part 1: General consensus sequence  -->

``` {r consensus-calculations}
#Categorise plots to represent in consensus sequences.
casp1H_data <- sequence_table %>% filter(cleaved_by == 1 & species == "H")
casp1M_data <- sequence_table %>% filter(cleaved_by == 1 & species == "M")
casp4_data <- sequence_table %>% filter(cleaved_by == 4)

casp_num <- nrow(sequence_table)
casp1H_num <- nrow(casp1H_data)
casp1M_num <- nrow(casp1M_data)
casp4_num <- nrow(casp4_data)
```

<!-- Figure references for visualisation segment -->

(ref:generic-cons-fig) Visualisation of inflammatory Caspase cleavage sites consensus categorised by chemistry. Top left: all Caspases (`r casp_num` sites), top right: Caspase-4 (`r casp4_num`), bottom left: human Caspase-1 (`r casp1H_num`), bottom right: murine Caspase-1 (`r casp1M_num`).

<!-- End references segement -->

The acquired database of inflammatory caspase substrates was tidied into an amenable format, and cleavage site consensus interpreted with ggseqlogo [@wagih_2017]. 

Amino acids were categorised by chemical properties- acidity/basicity, hydrophobicity/polarity, and visualised in four plots: all `r casp_num` inflammatory caspase substrates, `r casp1H_num` human Caspase-1 substrates, `r casp1M_num` murine Caspase-1 substrates and `r casp4_num` human-exclusive Caspase-4 substrates. Human Caspase-5 and murine Caspase-11 substrate consensus is not presented as few substrates have been recorded. Visualisations are shown in Figure \@ref(fig:consensus-fig).

```{r consensus-fig, out.width = "100%", fig.cap = "(ref:generic-cons-fig)"}

#Draw plots for consensus sequences. Standard presentation is using bits, but there is not much of a pattern here (that's the focus of the work anyway) so probability presentation looks a lot better.
all_casp <- ggseqlogo(sequence_table$sequence, seq_type = "aa", method = "prob") +
  theme()
casp1H <- ggseqlogo(casp1H_data$sequence, seq_type = "aa", method = "prob")
casp1M <- ggseqlogo(casp1M_data$sequence, seq_type = "aa", method = "prob")
casp4 <- ggseqlogo(casp4_data$sequence, seq_type = "aa", method = "prob")

#Present consensus sequence plots in grid.
grid.arrange(all_casp, casp4, casp1H, casp1M, ncol=2)

```

<!-- Part 2: Example consensus sequences under different properties -->

The.... words and stuff go here

## Phosphate site analysis

The limited history of proteomic analysis performed on apopototic caspases suggested that phosphorylation at cleavage sites can impact the efficiency of proteolysis [@dix_2012].

Data was tidied into an amenable format for analysis with phosphate site prediction software, DeepPhos [@luo_2019] which is capable of identification of previously unknown phosphate sites.

```{python deep-phos}
#Suppress warnings generated by future deprecated libraries
import warnings
warnings.filterwarnings('ignore')

#Load forked/modified deepphos code
#from deepphos import predict

#Run deepphos predictions
#predict.predict_for_deepphos('./data/processed/all_potential_ST.csv', "ST")
#predict.predict_for_deepphos('./data/processed/all_potential_Y.csv', "Y")

```

# References
<!-- Comment required for references section to number -->

